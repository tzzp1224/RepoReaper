<!DOCTYPE html>
<html>
<head>
    <title>GitHub RAG Agent</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; color: #333; }
        h1 { border-bottom: 2px solid #eee; padding-bottom: 0.5rem; }
        
        /* å¸ƒå±€ */
        .container { display: flex; gap: 20px; }
        .left-panel { flex: 2; }
        .right-panel { flex: 1; border-left: 1px solid #eee; padding-left: 20px; display: flex; flex-direction: column; height: 80vh; }

        /* ç»„ä»¶æ ·å¼ */
        input[type="text"] { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;}
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; }

        #logs { background: #f8f9fa; padding: 1rem; border-radius: 8px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; margin-bottom: 1rem;}
        #report { background: white; padding: 1rem; border: 1px solid #eee; border-radius: 8px; min-height: 200px; white-space: pre-wrap; line-height: 1.6; }
        
        /* èŠå¤©éƒ¨åˆ† */
        #chat-history { flex: 1; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px; margin-bottom: 10px; background: #fff; }
        .msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 12px; max-width: 85%; font-size: 0.9rem; }
        .msg.user { background: #007bff; color: white; align-self: flex-end; margin-left: auto; }
        .msg.ai { background: #f1f0f0; color: #333; }
        .source-tag { font-size: 0.75rem; color: #666; margin-top: 4px; font-style: italic; }
    </style>
</head>
<body>
    <h1>ğŸ§  GitHub RAG Agent (Chat with Code)</h1>
    
    <div class="container">
        <div class="left-panel">
            <h3>1. é¡¹ç›®åˆ†æ (Indexing)</h3>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="repoUrl" value="https://github.com/fastapi/fastapi" placeholder="GitHub URL...">
                <button onclick="startAnalysis()" id="btn-analyze">å¼€å§‹åˆ†æ</button>
            </div>
            
            <div id="logs">Waiting to analyze...</div>
            <div id="report">æŠ¥å‘Šå°†åœ¨è¿™é‡Œç”Ÿæˆ...</div>
        </div>

        <div class="right-panel">
            <h3>2. æ™ºèƒ½é—®ç­” (Chat)</h3>
            <div id="chat-history">
                <div class="msg ai">ä½ å¥½ï¼è¯·å…ˆç‚¹å‡»å·¦ä¾§â€œå¼€å§‹åˆ†æâ€ï¼Œç­‰æˆ‘è¯»å®Œä»£ç åï¼Œä½ å°±å¯ä»¥é—®æˆ‘å…³äºä»£ç çš„é—®é¢˜äº†ã€‚</div>
            </div>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="chatInput" placeholder="ä¾‹å¦‚ï¼šé‰´æƒé€»è¾‘åœ¨å“ªé‡Œï¼Ÿ" onkeypress="handleKeyPress(event)">
                <button onclick="sendChat()" id="btn-chat" disabled>å‘é€</button>
            </div>
        </div>
    </div>

    <script>
        // --- åˆ†æåŠŸèƒ½ ---
        function startAnalysis() {
            const url = document.getElementById('repoUrl').value;
            const logDiv = document.getElementById('logs');
            const reportDiv = document.getElementById('report');
            const btnAnalyze = document.getElementById('btn-analyze');
            const btnChat = document.getElementById('btn-chat');
            
            // é‡ç½®çŠ¶æ€
            logDiv.innerHTML = "";
            reportDiv.innerHTML = "";
            btnAnalyze.disabled = true;
            btnChat.disabled = true; // åˆ†æä¸­ç¦æ­¢èŠå¤©

            const eventSource = new EventSource(`http://127.0.0.1:8000/analyze?url=${encodeURIComponent(url)}`);

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.step === 'report_chunk') {
                    reportDiv.innerHTML += data.chunk;
                } else if (data.step === 'finish') {
                    logDiv.innerHTML += `<div style="color:green">âœ… ${data.message}</div>`;
                    eventSource.close();
                    btnAnalyze.disabled = false;
                    btnChat.disabled = false; // å…è®¸èŠå¤©
                    addMsg("ai", "æˆ‘å·²ç»è¯»å®Œä»£ç äº†ï¼Œç°åœ¨ä½ å¯ä»¥é—®æˆ‘ä»»ä½•é—®é¢˜ï¼");
                } else if (data.step === 'error') {
                    logDiv.innerHTML += `<div style="color:red">âŒ ${data.message}</div>`;
                    eventSource.close();
                    btnAnalyze.disabled = false;
                } else {
                    logDiv.innerHTML += `<div>ğŸ‘‰ ${data.message}</div>`;
                    logDiv.scrollTop = logDiv.scrollHeight;
                }
            };
        }

        // --- èŠå¤©åŠŸèƒ½ ---
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const history = document.getElementById('chat-history');
            const query = input.value.trim();
            if (!query) return;

            // æ˜¾ç¤ºç”¨æˆ·é—®é¢˜
            addMsg("user", query);
            input.value = "";

            // æ˜¾ç¤º AI æ€è€ƒä¸­
            const loadingId = addMsg("ai", "ğŸ¤” æ­£åœ¨æ£€ç´¢ä»£ç åº“...");

            try {
                const res = await fetch("http://127.0.0.1:8000/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ query: query })
                });
                const data = await res.json();
                
                // ç§»é™¤æ€è€ƒä¸­ï¼Œæ˜¾ç¤ºçœŸå®ç­”æ¡ˆ
                document.getElementById(loadingId).remove();
                
                let answerHtml = data.answer;
                if (data.sources && data.sources.length > 0) {
                    answerHtml += `<div class="source-tag">å‚è€ƒæ–‡ä»¶: ${data.sources.join(", ")}</div>`;
                }
                addMsg("ai", answerHtml, true);

            } catch (err) {
                addMsg("ai", "âŒ å‡ºé”™äº†: " + err.message);
            }
        }

        function addMsg(role, text, isHtml=false) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.id = "msg-" + Date.now();
            if (isHtml) div.innerHTML = text;
            else div.textContent = text;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
            return div.id;
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendChat();
        }
    </script>
</body>
</html>